---
title: "Lab3"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
library(markovchain)
library(expm)

knitr::opts_chunk$set(echo = TRUE)
options(scipen=999, digits=4)
```

# Вариант 8

* Интенсивности отказов и восстановлений серверов: $\lambda_1 = 4*10^{-4}$ 1/ч, $\mu_1 = 2$ 1/ч
* Интенсивности отказов и восстановлений коммутационных узлов: $\lambda_2 = 1*10^{-4}$ 1/ч, $\mu_2 = 1$ 1/ч
* Вариант резервирования и восстановления: (А1, В3, C1)
* Число узлов $(m, n) = (2, 3)$

Объектом исследования является кластер, состоящий из $m$ серверов и $n$ коммуникационных узлов:

![Рисунок 1. Модель кластера](Lab3/Model.png)

Порядок резервирования и восстановления:

* А1: серверы и коммутационные узлы работают в нагруженном резерве;
* B3: приоритет восстановления выше для узлов, ремонт которых непосредственно приводит к переходу системы из неработоспособного в работоспособное состояние; в остальных случаях приоритет коммуникационных узлов выше;
* С1: после перехода системы в состояние отказа электропитание отключается; предполагаем, что в состоянии отказа системы узлы, сохранившие работоспособность, не отказывают.

# Задание

Для заданного варианта организации системы:

* построить диаграмму состояний и переходов;
* в соответствии с диаграммой состояний и переходов составить систему алгебраических уравнений;
* в соответствии с диаграммой состояний и переходов составить систему дифференциальных уравнений;
* с использование средств компьютерной математики решить систему алгебраических уравнений;
* с использование средств компьютерной математику решить систему дифференциальных уравнений;
* определить стационарный коэффициент готовности;
* определить нестационарный коэффициент готовности;
* определить нестационарный коэффициент готовности при холодном резерве;
* представить зависимость нестационарного коэффициента готовности от времени в виде графика;
* построить диаграмму состояний и переходов для невосстанавливаемой системы с учетом заданного варианта нагруженного или ненагруженного резерва;
* в соответствии с диаграммой состояний и переходов составить систему дифференциальных уравнений; 
* с использование средств компьютерной математику решить систему дифференциальных уравнений;
* определить зависимость вероятности безотказной работы системы от времени ее функционирования (результаты представить в виде графиков);
* проанализировать полученные результаты.

# Восстанавливаемая система

## Построение графа состояний и переходов

![Рисунок 2. Граф состояний и переходов в восстанавливаемой системе при нагруженном резерве](Lab3/Graph-L.png)

![Рисунок 3. Граф состояний и переходов в восстанавливаемой системе при холодном (ненагруженном) резерве](Lab3/Graph.png)

## Построение и решение системы алгебраических уравнений

```{r}
states <- c("23", "22", "21", "20", "13", "12", "11", "10", "03", "02", "01")

lambda1 <- 4*10^-4
mu1 <- 2
lambda2 <- 1*10^-4
mu2 <- 1
```

### Нагруженный резерв

Матрица интенсивностей переходов:

```{r}
transition_rate_hot_reserve_M <- matrix(
  data = c(
    0,3*lambda2,0,0,2*lambda1,0,0,0,0,0,0,
    mu2,0,2*lambda2,0,0,2*lambda1,0,0,0,0,0,
    0,mu2,0,lambda2,0,0,2*lambda1,0,0,0,0,
    0,0,mu2,0,0,0,0,0,0,0,0,
    mu1,0,0,0,0,3*lambda2,0,0,lambda1,0,0,
    0,0,0,0,mu2,0,2*lambda2,0,0,lambda1,0,
    0,0,0,0,0,mu2,0,lambda2,0,0,lambda1,
    0,0,0,0,0,0,mu2,0,0,0,0,
    0,0,0,0,mu1,0,0,0,0,0,0,
    0,0,0,0,0,mu1,0,0,0,0,0,
    0,0,0,0,0,0,mu1,0,0,0,0
  ),
  byrow = T, ncol = 11, dimnames = list(states, states))
diag(transition_rate_hot_reserve_M) <- -rowSums(transition_rate_hot_reserve_M)
transition_rate_hot_reserve_M
```

Стационарные вероятности:

```{r}
mc_hot <- new("markovchain", states = states, byrow = T, transitionMatrix = expm(transition_rate_hot_reserve_M))
steady_hot <- steadyStates(mc_hot)
steady_hot
```

### Холодный резерв

Матрица интенсивностей переходов:

```{r}
transition_rate_cold_reserve_M <- matrix(
  data = c(
    0,lambda2,0,0,lambda1,0,0,0,0,0,0,
    mu2,0,lambda2,0,0,lambda1,0,0,0,0,0,
    0,mu2,0,lambda2,0,0,lambda1,0,0,0,0,
    0,0,mu2,0,0,0,0,0,0,0,0,
    mu1,0,0,0,0,lambda2,0,0,lambda1,0,0,
    0,0,0,0,mu2,0,lambda2,0,0,lambda1,0,
    0,0,0,0,0,mu2,0,lambda2,0,0,lambda1,
    0,0,0,0,0,0,mu2,0,0,0,0,
    0,0,0,0,mu1,0,0,0,0,0,0,
    0,0,0,0,0,mu1,0,0,0,0,0,
    0,0,0,0,0,0,mu1,0,0,0,0
  ),
  byrow = T, ncol = 11, dimnames = list(states, states))
diag(transition_rate_cold_reserve_M) <- -rowSums(transition_rate_cold_reserve_M)
transition_rate_cold_reserve_M
```

Стационарные вероятности:

```{r}
mc_cold <- new("markovchain", states = states, byrow = T, transitionMatrix = expm(transition_rate_cold_reserve_M))
steady_cold <- steadyStates(mc_cold)
steady_cold
```

## Определение стационарного коэффициента готовности

Готовность системы определяется как сумма ее работоспособных состояний. Для определения стационарного коэффициента готовности просуммируем стационарные вероятности рабочих состояний:

$$K_r = p_{23} + p_{22} + p_{21} + p_{13} + p_{12} + p_{11}$$

При нагруженном резерве:

```{r}
sum(steady_hot[,"23"], steady_hot[,"22"], steady_hot[,"21"], steady_hot[,"13"], steady_hot[,"12"], steady_hot[,"11"])
```

При холодном резерве:

```{r}
sum(steady_cold[,"23"], steady_cold[,"22"], steady_cold[,"21"], steady_cold[,"13"], steady_cold[,"12"], steady_cold[,"11"])
```

## Построение системы дифференциальных уравнений для нагруженного резерва

$$
\frac{d}{dt}P_{23}(t) = -(2\lambda_1 + 3\lambda_2) P_{23}(t) + \mu_1 P_{13}(t) + \mu_2 P_{22}(t),\\
\frac{d}{dt}P_{13}(t) = -(\lambda_1 + 3\lambda_2 + \mu_1) P_{13}(t) + 2\lambda_1 P_{23}(t) + \mu_1 P_{03}(t) + \mu_2 P_{12}(t),\\
\frac{d}{dt}P_{03}(t) = -\mu_1 P_{03} (t) + \lambda_1 P_{13}(t),\\
\frac{d}{dt}P_{22}(t) = -(\mu_2 + 2\lambda_1 + 2\lambda_2) P_{22}(t) + 3\lambda_2 P_{23}(t) + \mu_2 P_{21}(t),\\
\frac{d}{dt}P_{12}(t) = -(\mu_2 + \lambda_1 + 2\lambda_2) P_{12}(t) + 2\lambda_1 P_{22}(t) + 3\lambda_2 P_{13}(t) + \mu_1 P_{02}(t) + \mu_2 P_{11}(t),\\
\frac{d}{dt}P_{02}(t) = -\mu_1 P_{02}(t) + \lambda_1 P_{12}(t),\\
\frac{d}{dt}P_{21}(t) = -(\mu_2 + 2\lambda_1 + \lambda_2) P_{21}(t) + 2\lambda_2 P_{22}(t) + \mu_2 P_{20}(t),\\
\frac{d}{dt}P_{11}(t) = -(\mu_2 + \lambda_1 + \lambda_2) P_{11}(t) + 2\lambda_1 P_{21}(t) + 2\lambda_2 P_{12}(t) + \mu_1 P_{01}(t) + \mu_2 P_{10}(t),\\
\frac{d}{dt}P_{01}(t) = -\mu_1 P_{01}(t) + \lambda_1 P_{11}(t),\\
\frac{d}{dt}P_{20}(t) = -\mu_2 P_{20}(t) + \lambda_2 P_{21}(t),\\
\frac{d}{dt}P_{10}(t) = -\mu_2 P_{10}(t) + \lambda_2 P_{11}(t)
$$

## Построение системы дифференциальных уравнений для ненагруженного резерва

$$
\frac{d}{dt}P_{23}(t) = -(\lambda_1 + \lambda_2) P_{23}(t) + \mu_1 P_{13}(t) + \mu_2 P_{22}(t),\\
\frac{d}{dt}P_{13}(t) = -(\lambda_1 + \lambda_2 + \mu_1) P_{13}(t) + \lambda_1 P_{23}(t) + \mu_1 P_{03}(t) + \mu_2 P_{12}(t),\\
\frac{d}{dt}P_{03}(t) = -\mu_1 P_{03} (t) + \lambda_1 P_{13}(t),\\
\frac{d}{dt}P_{22}(t) = -(\mu_2 + \lambda_1 + \lambda_2) P_{22}(t) + \lambda_2 P_{23}(t) + \mu_2 P_{21}(t),\\
\frac{d}{dt}P_{12}(t) = -(\mu_2 + \lambda_1 + \lambda_2) P_{12}(t) + \lambda_1 P_{22}(t) + \lambda_2 P_{13}(t) + \mu_1 P_{02}(t) + \mu_2 P_{11}(t),\\
\frac{d}{dt}P_{02}(t) = -\mu_1 P_{02}(t) + \lambda_1 P_{12}(t),\\
\frac{d}{dt}P_{21}(t) = -(\mu_2 + \lambda_1 + \lambda_2) P_{21}(t) + \lambda_2 P_{22}(t) + \mu_2 P_{20}(t),\\
\frac{d}{dt}P_{11}(t) = -(\mu_2 + \lambda_1 + \lambda_2) P_{11}(t) + \lambda_1 P_{21}(t) + \lambda_2 P_{12}(t) + \mu_1 P_{01}(t) + \mu_2 P_{10}(t),\\
\frac{d}{dt}P_{01}(t) = -\mu_1 P_{01}(t) + \lambda_1 P_{11}(t),\\
\frac{d}{dt}P_{20}(t) = -\mu_2 P_{20}(t) + \lambda_2 P_{21}(t),\\
\frac{d}{dt}P_{10}(t) = -\mu_2 P_{10}(t) + \lambda_2 P_{11}(t)
$$

## Определение нестационарного коэффициента готовности

Для определения нестационарного коэффициента готовности суммируются вероятности рабочих состояний:

$$K_r(t) = P_{23}(t) + P_{22}(t) + P_{21}(t) + P_{13}(t) + P_{12}(t) + P_{11}(t)$$

Решим систему дифферециальных уравнений при помощи нахождения экспоненты матрицы интенсивностей переходов, умноженной на время $t$:

```{r}
initial_state <- "23"
p_hot <- function(t, s) expm(t*transition_rate_hot_reserve_M)[initial_state, s]
p_cold <- function(t, s) expm(t*transition_rate_cold_reserve_M)[initial_state, s]
```

Нагруженный резерв:

```{r}
k_r_hot <- function(t) p_hot(t, "23") + p_hot(t, "22") + p_hot(t, "21") + p_hot(t, "13") + p_hot(t, "12") + p_hot(t, "11")
```

Холодный резерв:

```{r}
k_r_cold <- function(t) p_cold(t, "23") + p_cold(t, "22") + p_cold(t, "21") + p_cold(t, "13") + p_cold(t, "12") + p_cold(t, "11")
```

## Построение графика зависимости нестационарного коэффициента готовности от времени

```{r, warning=F}
t <- seq(0, 10, 0.1)
k_r_hot_t <- sapply(t, k_r_hot)
k_r_cold_t <- sapply(t, k_r_cold)

par(mar = c(4, 8, 2, 2))
plot(t, k_r_hot_t, type="l", col="red", axes = F, xlab="Время, ч", ylab="", ylim=c(0.99999992, 1.000000000000001))
lines(t, k_r_cold_t, col="blue")
axis(1, at=c(0, 2, 5, 10))
axis(2, at=c(0.99999992, 0.99999996, 1.0000000000000), labels=c(0.99999992, 0.99999996, 1.0000000000000), las = 2)
title(ylab = "Коэффициент готовности", line = 6)
legend("topright", c("Нагруженный резерв", "Холодный резерв"), fill=c("red", "blue"))
```

*Рисунок 4. График зависимости нестационарного коэффициента готовности от времени*

# Невосстанавливаемая система

## Построение графа состояний и переходов

![Рисунок 5. Граф состояний и переходов в невосстанавливаемой системе при нагруженном резерве](Lab3/Graph-Unrec.png)

## Построение и решение системы алгебраических уравнений

Матрица интенсивностей переходов:

```{r}
states_unrec <- c("23", "22", "21", "20", "13", "12", "11", "10", "03", "02", "01", "00")

transition_rate_unrec_M <- matrix(
  data = c(
    0,3*lambda2,0,0,2*lambda1,0,0,0,0,0,0,0,
    0,0,2*lambda2,0,0,2*lambda1,0,0,0,0,0,0,
    0,0,0,lambda2,0,0,2*lambda1,0,0,0,0,0,
    0,0,0,0,0,0,0,2*lambda1,0,0,0,0,
    0,0,0,0,0,3*lambda2,0,0,lambda1,0,0,0,
    0,0,0,0,0,0,2*lambda2,0,0,lambda1,0,0,
    0,0,0,0,0,0,0,lambda2,0,0,lambda1,0,
    0,0,0,0,0,0,0,0,0,0,0,lambda1,
    0,0,0,0,0,0,0,0,0,3*lambda2,0,0,
    0,0,0,0,0,0,0,0,0,0,2*lambda2,0,
    0,0,0,0,0,0,0,0,0,0,0,lambda2,
    0,0,0,0,0,0,0,0,0,0,0,0
  ),
  byrow = T, ncol = 12, dimnames = list(states_unrec, states_unrec))
diag(transition_rate_unrec_M) <- -rowSums(transition_rate_unrec_M)
transition_rate_unrec_M
```

Расчет стационарных вероятностей не требуется, так как без возможности восстановления система с течением времени окажется в состоянии полного отказа (`00`) и не сможет из него вернуться.

## Построение системы дифференциальных уравнений

$$
\frac{d}{dt}P_{23}(t) = -(2\lambda_1 + 3\lambda_2) P_{23}(t),\\
\frac{d}{dt}P_{13}(t) = -(\lambda_1 + 3\lambda_2) P_{13}(t) + 2\lambda_1 P_{23}(t),\\
\frac{d}{dt}P_{03}(t) = -3\lambda_2 P_{03}(t) + \lambda_1 P_{13}(t),\\
\frac{d}{dt}P_{22}(t) = -(2\lambda_1 + 2\lambda_2) P_{22}(t) + 3\lambda_2 P_{23}(t),\\
\frac{d}{dt}P_{12}(t) = -(\lambda_1 + 2\lambda_2) P_{12}(t) + 2\lambda_1 P_{22}(t) + 3\lambda_2 P_{13}(t),\\
\frac{d}{dt}P_{02}(t) = -2\lambda_2 P_{02}(t) + \lambda_1 P_{12}(t) + 3\lambda_2 P_{03}(t),\\
\frac{d}{dt}P_{21}(t) = -(2\lambda_1 + \lambda_2) P_{21}(t) + 2\lambda_2 P_{22}(t),\\
\frac{d}{dt}P_{11}(t) = -(\lambda_1 + \lambda_2) P_{11}(t) + 2\lambda_1 P_{21}(t) + 2\lambda_2 P_{12}(t),\\
\frac{d}{dt}P_{01}(t) = -\lambda_2 P_{01}(t) + \lambda_1 P_{11}(t) + 2\lambda_2 P_{02}(t),\\
\frac{d}{dt}P_{20}(t) = -2\lambda_1 P_{20}(t) + \lambda_2 P_{21}(t),\\
\frac{d}{dt}P_{10}(t) = -\lambda_1 P_{10}(t) + \lambda_2 P_{11}(t) + 2\lambda_1 P_{20},\\
\frac{d}{dt}P_{00}(t) = \lambda_2 P_{01}(t) + \lambda_1 P_{10}
$$

## Определение нестационарного коэффициента готовности

Для определения нестационарного коэффициента готовности суммируются вероятности рабочих состояний:

$$K_r(t) = P_{23}(t) + P_{22}(t) + P_{21}(t) + P_{13}(t) + P_{12}(t) + P_{11}(t)$$

Решим систему дифферециальных уравнений при помощи нахождения экспоненты матрицы интенсивностей переходов, умноженной на время $t$:

```{r}
initial_state <- "23"
p_unrec <- function(t, s) expm(t*transition_rate_unrec_M)[initial_state, s]
k_r_unrec <- function(t) p_unrec(t, "23") + p_unrec(t, "22") + p_unrec(t, "21") + p_unrec(t, "13") + p_unrec(t, "12") + p_unrec(t, "11")
```

## Построение графика зависимости нестационарного коэффициента готовности от времени

```{r, warning=F}
t <- seq(0, 15000, 100)
k_r_unrec_t <- sapply(t, k_r_unrec)

par(mar = c(4, 8, 2, 2))
plot(t, k_r_unrec_t, type="l", axes = F, xlab="Время, ч", ylab="", ylim=c(0, 1.000000000000001))
axis(1, at=c(0, 2500, 5000, 10000, 15000))
axis(2, at=c(0, 1.0000000000000), labels=c(0, 1.0000000000000), las = 2)
title(ylab = "Коэффициент готовности", line = 6)
```

*Рисунок 6. График зависимости нестационарного коэффициента готовности от времени, невосстанавливаемая система*

# Вывод

В ходе выполнения работы для заданного варианта организации системы была построена марковская модель надежности,
при этом рассмотрены две дисциплины резервирования (нагруженный резерв и холодный резерв).

