---
title: "Lab4"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
library(markovchain)
library(expm)

knitr::opts_chunk$set(echo = TRUE)
```

# Вариант 8

```{r}
lambda1 = 10^-4   # Интенсивность отказов вычислительных машин, 1/ч
mu1 = 1           # Инт. восстановлений вычислительных машин, 1/ч
lambda2 = 2*10^-4 # Инт. отказов устройств хранения, 1/ч
mu21 = 1          # Инт. физического восстановления устройств хр., 1/ч
mu22 = 0.1        # Инт. загрузки информации в устройства хр., 1/ч
```

Сравнить 11 и 21:

## Модель 11

![Рисунок 1. Модель 11](Lab4/Model11.png)

![Рисунок 2. Граф состояний и переходов 11](Lab4/Compare11.png)

## Модель 21

![Рисунок 3. Модель 21](Lab4/Model21.png)

![Рисунок 4. Граф состояний и переходов 21](Lab4/Compare21.png)

На представленных диаграммах при кодировании состояний первая позиция соответствует ВМ, вторая – устройству хранения. Возможные состояния:

* "1": работоспособное состояние;
* "0": состояние отказа;
* "F": (только для устройств хранения) состояние, при котором устройство физически восстановлено, но информация в него еще не загружена.

# Задание

1. Построить диаграммы состояний и переходов марковской модели.
2. Составить алгебраические уравнения.
3. Составить систему дифференциальных уравнений.
4. Определить стационарный и нестационарный коэффициенты готовности.
5. Преобразовать граф состояний и переходов, представив все неработоспособные состояния одним финальным состоянием, что на графике позволяет оценить наработку до отказа.
Составить дифференциальные уравнения.
6. По составленным системам дифференциальных уравнений построить графики коэффициента готовности и вероятности работоспособных состояний от времени для случаев с финальными состояниями.
Кривые для сравниваемых вариантов  желательно представить на одном графике.
7. Сделать выводы по проведенным исследованиям.

# Составление систем алгебраических уравнений

Системы представлены в виде матриц интенсивностей переходов.

## Модель 11

```{r}
states_11 <- c("11", "10", "01", "1F", "0F")
transition_rate_11 <- matrix(
  data = c(
    0,lambda2,lambda1,0,0,
    0,0,0,mu21,0,
    mu1,0,0,0,0,
    mu22,lambda2,0,0,lambda1,
    0,0,0,mu1,0
  ),
  byrow = T, ncol = length(states_11), dimnames = list(states_11, states_11))
diag(transition_rate_11) <- -rowSums(transition_rate_11)
transition_rate_11
```

Стационарные вероятности:

```{r}
mc_11 <- as(expm(transition_rate_11), "markovchain")
steady_11 <- steadyStates(mc_11)
steady_11
```

## Модель 21

```{r}
states_21 <- c("111", "101", "100", "1F1", "1F0", "0F1", "0F0", "011", "001")
transition_rate_21 <- matrix(
  data = c(
    0,2*lambda2,0,0,0,0,0,lambda1,0,
    0,0,lambda2,mu21,0,0,0,0,lambda1,
    0,0,0,0,mu21,0,0,0,0,
    mu22,lambda2,0,0,lambda2,lambda1,0,0,0,
    0,mu22,lambda2,0,0,0,lambda1,0,0,
    0,0,0,mu1,0,0,0,0,0,
    0,0,0,0,mu1,0,0,0,0,
    mu1,0,0,0,0,0,0,0,0,
    0,mu1,0,0,0,0,0,0,0
  ),
  byrow = T, ncol = length(states_21), dimnames = list(states_21, states_21))
diag(transition_rate_21) <- -rowSums(transition_rate_21)
transition_rate_21
```

Стационарные вероятности:

```{r}
mc_21 <- as(expm(transition_rate_21), "markovchain")
steady_21 <- steadyStates(mc_21)
steady_21
```

# Составление системы дифференциальных уравнений

## Модель 11

$$
\frac{d}{dt}P_{01}(t) = -\mu_1 P_{01}(t) + \lambda_1 P_{11}(t),\\
\frac{d}{dt}P_{11}(t) = -(\lambda_1 + \lambda_2) P_{11}(t) + \mu_1 P_{01}(t) + \mu_{22} P_{1F}(t) ,\\
\frac{d}{dt}P_{10}(t) = -\mu_{21} P_{10}(t) + \lambda_2 P_{1F}(t) + \lambda_2 P_{11}(t),\\
\frac{d}{dt}P_{1F}(t) = -(\mu_{22} + \lambda_2 + \lambda_1) P_{1F}(t) + \mu_{21} P_{10}(t) + \mu_1 P_{0F}(t),\\
\frac{d}{dt}P_{0F}(t) = -\mu_1 P_{0F}(t) + \lambda_1 P_{1F}(t)
$$

## Модель 21

$$
\frac{d}{dt}P_{011}(t) = -\mu_1 P_{011}(t) + \lambda_1 P_{111}(t),\\
\frac{d}{dt}P_{001}(t) = -\mu_1 P_{001}(t) + \lambda_1 P_{101}(t),\\
\frac{d}{dt}P_{111}(t) = -(\lambda_1 + 2\lambda_2) P_{111}(t) + \mu_1 P_{011}(t) + \mu_{22} P_{1F1}(t),\\
\frac{d}{dt}P_{101}(t) = -(\lambda_1 + \lambda_2 + \mu_{21}) P_{101}(t) + \mu_1 P_{001}(t) + 2\lambda_2 P_{111}(t) + \lambda_2 P_{1F1}(t) + \mu_{22} P_{1F0}(t),\\
\frac{d}{dt}P_{100}(t) = -\mu_{21} P_{100}(t) + \lambda_2 P_{101}(t) + \lambda_2 P_{1F0}(t),\\
\frac{d}{dt}P_{1F1}(t) = -(\mu_{22} + \lambda_2 + \lambda_2 + \lambda_1) P_{1F1}(t) + \mu_{21} P_{101}(t) + \mu_1 P_{0F1}(t),\\
\frac{d}{dt}P_{1F0}(t) = -(\mu_{22 + \lambda_2 + \lambda_1}) P_{1F0}(t) + \mu_{21} P_{100}(t) + \lambda_2 P_{1F1}(t) + \mu_1 P_{0F0}(t),\\
\frac{d}{dt}P_{0F1}(t) = -\mu_1 P_{0F1}(t) + \lambda_1 P_{1F1}(t),\\
\frac{d}{dt}P_{0F0}(t) = -\mu_1 P_{0F0}(t) + \lambda_1 P_{1F0}(t)
$$

# Определение стационарного коэффициента готовности

Готовность системы определяется как сумма ее работоспособных состояний. Для определения стационарного коэффициента готовности просуммируем стационарные вероятности рабочих состояний:

## Модель 11

$$K_r = P_{11}$$
```{r}
steady_11[,"11"]
```

## Модель 21

$$K_r = P_{111} + P_{101} + P_{1F1}$$

```{r}
steady_21[,"111"] + steady_21[,"101"] + steady_21[,"1F1"]
```

# Определение нестационарного коэффициента готовности

```{r}
p_m11 <- function(t, s) expm(t*transition_rate_11)["11", s]
p_m21 <- function(t, s) expm(t*transition_rate_21)["111", s]

k_r_m11 <- function(t) p_m11(t, "11")
k_r_m21 <- function(t) p_m21(t, "111") + p_m21(t, "101") + p_m21(t, "1F1")
```

График коэффициента готовности в зависимости от времени:

```{r, warning=F}
t <- seq(0, 80, 0.4)
k_r_t_m11 <- sapply(t, k_r_m11)
k_r_t_m21 <- sapply(t, k_r_m21)

par(mar = c(4, 8, 2, 2))
plot(t, k_r_t_m11, type="l", col="red", axes = F, xlab="Время, ч", ylab="", ylim=c(0.9976, 1.000000000000001))
lines(t, k_r_t_m21, col="blue")
axis(1, at=c(0, 10, 40, 80))
axis(2, at=c(0.9976, 0.9999, 1.0000000000000), labels=c(0.9976, 0.9999, 1.0000000000000), las = 2)
title(ylab = "Коэффициент готовности", line = 6)
legend("right", c("Модель 11", "Модель 21"), fill=c("red", "blue"))
```

*Рисунок 5. График зависимости нестационарного коэффициента готовности от времени*

# Составление системы с одним финальным состоянием

## Граф состояний и переходов

Определим $\mu_2$ как интенсивность полного восстановления устройств хранения:
$$\mu_2 = \frac{1}{\frac{1}{\mu_{21}} + \frac{1}{\mu_{22}}} = \frac{\mu_{21}\mu_{22}}{\mu_{21} + \mu_{22}}$$

```{r}
mu2 = (mu21 * mu22) / (mu21 + mu22)
```

![Рисунок 6. Граф состояний и переходов 11 с одним финальным состоянием](Lab4/GraphSingle11.png)

$$\lambda = \lambda_1 + \lambda_2,\ \mu = \mu_1 + \mu_2$$

![Рисунок 7. Граф состояний и переходов 21 с одним финальным состоянием](Lab4/GraphSingle21.png)

$$
\lambda_{111} = \lambda_1,\ \mu_{111} = \mu_1,\\
\lambda_{101} = \lambda_1 + \lambda_2,\ \mu_{101} = \mu_1 + \mu_2,\\
\lambda_{1F1} = \lambda_1 + \lambda_2,\ \mu_{1F1} = \mu_1 + \mu_2
$$

## Составление систем алгебраических уравнений

Системы представлены в виде матриц интенсивностей переходов.

### Модель 11

Матрица интенсивностей переходов:

```{r}
states_11x <- c("11", "X")
transition_rate_11x <- matrix(
  data = c(
    0, (lambda1 + lambda2),
    (mu1 + mu2), 0
  ),
  byrow = T, ncol = length(states_11x), dimnames = list(states_11x, states_11x))
diag(transition_rate_11x) <- -rowSums(transition_rate_11x)
transition_rate_11x
```

Стационарные вероятности:

```{r}
mc_11x <- as(expm(transition_rate_11x), "markovchain")
steady_11x <- steadyStates(mc_11x)
steady_11x
```

### Модель 21

Матрица интенсивностей переходов:

```{r}
states_21x <- c("111", "101", "1F1", "X")
transition_rate_21x <- matrix(
  data = c(
    0,2*lambda2,0,lambda1,
    0,0,mu21,(lambda1 + lambda2),
    mu22,lambda2,0,(lambda1 + lambda2),
    mu1,(mu1 + mu2),(mu1 + mu2),0
  ),
  byrow = T, ncol = length(states_21x), dimnames = list(states_21x, states_21x))
diag(transition_rate_21x) <- -rowSums(transition_rate_21x)
transition_rate_21x
```

Стационарные вероятности:

```{r}
mc_21x <- as(expm(transition_rate_21x), "markovchain")
steady_21x <- steadyStates(mc_21x)
steady_21x
```

## Составление систем дифференциальных уравнений

### Модель 11

$$
\frac{d}{dt}P_{11}(t) = -\lambda P_{11}(t) + \mu P_{X}(t),\\
\frac{d}{dt}P_{X}(t) = -\mu P_{X}(t) + \lambda P_{11}(t)
$$

### Модель 21

$$
\frac{d}{dt}P_{111}(t) = -(2\lambda_2 + \lambda_{111}) P_{111}(t) + \mu_{22} P_{1F1}(t) + \mu_{111} P_{X}(t),\\
\frac{d}{dt}P_{101}(t) = -(\mu_{21} + \lambda_{101}) P_{101}(t) + 2\lambda_2 P_{111}(t) + \lambda_2 P_{1F1}(t) + \mu_{101} P_{X}(t),\\
\frac{d}{dt}P_{1F1}(t) = -(\lambda_2 + \mu_{22} + \lambda_{1F1}) P_{1F1}(t) + \mu_{21} P_{101}(t) + \mu_{1F1} P_{X}(t),\\
\frac{d}{dt}P_{X}(t) = -(\mu_{101} + \mu_{111} + \mu_{1F1}) P_{X}(t) + \lambda_{111} P_{111}(t) + \lambda_{101} P_{101}(t) + \lambda_{1F1} P_{1F1}(t)
$$

## Определение нестационарного коэффициента готовности

```{r, warning=F}
p_m11x <- function(t, s) expm(t*transition_rate_11x)["11", s]
p_m21x <- function(t, s) expm(t*transition_rate_21x)["111", s]

k_r_m11x <- function(t) p_m11x(t, "11")
k_r_m21x <- function(t) p_m21x(t, "111") + p_m21x(t, "101") + p_m21x(t, "1F1")

t <- seq(0, 80, 0.4)
k_r_t_m11x <- sapply(t, k_r_m11x)
k_r_t_m21x <- sapply(t, k_r_m21x)

par(mar = c(4, 8, 2, 2))
plot(t, k_r_t_m11x, type="l", col="red", axes = F, xlab="Время, ч", ylab="", ylim=c(0.9997, 1.000000000000001))
lines(t, k_r_t_m21x, col="blue")
axis(1, at=c(0, 10, 40, 80))
axis(2, at=c(0.9997, 0.99997, 1.0000000000000), labels=c(0.9997, 0.99997, 1.0000000000000), las = 2)
title(ylab = "Коэффициент готовности", line = 6)
legend("right", c("Модель 11", "Модель 21"), fill=c("red", "blue"))
```

*Рисунок 8. График зависимости нестационарного коэффициента готовности от времени, вариант с финальными состояниями.*

# Вывод

В ходе выполнения работы был проведен сравнительный анализ двух систем, содержащих вычислительный модуль и модули хранения.
Коэффициент готовности для модели 11, содержащей один модуль хранения, оказался ниже, чем у модели 21, имеющей два модуля хранения.
Соответственно, можно сделать вывод, что система, имеющая дополнительный резервный модуль хранения, обладает большей надежностью.

Были также рассмотрены схемы, в которых все неработоспособные состояния представлены одним финальным состояниям.
Используемые приближения позволили рассчитать верхнюю границу зависимости нестационарного коэффициента готовности от времени.
